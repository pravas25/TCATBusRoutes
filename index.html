<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>

    <style>
    html,
    body {
        height: 100%;
        width: 100%;
    }
    body {
        margin: 0;
    }
    #map {
        width: 100%;
        height: 100%;
    }
    rect{
        fill:orange;
    }
    </style>

</head>

<body>
    <div id="map"></div>

    <script type="text/javascript">
    /*var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/examples.map-zr0njcqy/{z}/{x}/{y}.png', {
        attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    });*/
    var mapboxTiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'});

    var map = L.map('map')
        .addLayer(mapboxTiles)
        .setView([42.448, -76.475], 15);

    var svg = d3.select(map.getPanes().overlayPane).append("svg");
    var g = svg.append("g").attr("class", "leaflet-zoom-hide");

    d3.json("points.geojson", function(data) {
        var dataPoints = data.features.filter(function(d) {
            return d.properties.id == "route1"
        });
        console.log(dataPoints[dataPoints.length-1]);
        var transform = d3.geo.transform ({
            point: projectPoint
        });

        var d3path = d3.geo.path().projection(transform);

        function projectPoint(x, y) {
            var point = map.latLngToLayerPoint(new L.LatLng(y, x));
            this.stream.point(point.x, point.y);
        } 

        var toLine = d3.svg.line()
            .interpolate("linear")
            .x(function (d) {
                return applyLatLng(d).x
            })
            .y(function (d) {
                return applyLatLng(d).y
            });

        function applyLatLng(d) {
            var y = d.geometry.coordinates[1]
            var x = d.geometry.coordinates[0]
            return map.latLngToLayerPoint(new L.LatLng(y, x))
        }

        var busStops = g.selectAll("circle")
            .data(dataPoints)
            .enter()
            .append("circle")
            .attr("r",2)
            .attr("class", function (d) {
               return "waypoints" + "c" + d.properties.time
            })
            .style("fill", "blue");

        var linePath = g.selectAll(".lineConnect")
                .data([dataPoints])
                .enter()
                .append("path")
                .attr("class", "lineConnect")
                .style("fill", "none")
                .style("stroke", "black")
                .style("stroke-width", "2");

        var bus = g.append("rect");
        bus.attr("width", 15).attr("height", 15).attr("id", "bus");

        map.on("viewreset", reset);
        reset();

        var location1 = applyLatLng(dataPoints[0]);
        var location2 = applyLatLng(dataPoints[dataPoints.length-1]);
        bus.attr("transform", "translate(" + location1.x + "," + location1.y + ")");

        setInterval(function() {
            var d = new Date() + "";
            var hours_min = d.substring(16,21);
            //TODO: get start time of bus and update bus location depending on that time and duration of total commute.
        }, 1000);

        L.marker([dataPoints[0].geometry.coordinates[1], dataPoints[0].geometry.coordinates[0]]).addTo(map).bindPopup("From this location (e.g. A Lot)").openPopup();
        L.marker([dataPoints[dataPoints.length-1].geometry.coordinates[1], dataPoints[dataPoints.length-1].geometry.coordinates[0]]).addTo(map).bindPopup('To this location (e.g. Uris)').openPopup();

        function reset() {
            var bounds = d3path.bounds(data),
                    topLeft = bounds[0],
                    bottomRight = bounds[1];

            busStops.attr("transform",
                function(d) {
                    return "translate(" +
                        applyLatLng(d).x + "," +
                        applyLatLng(d).y + ")";
                });
                
            svg.attr("width", bottomRight[0] - topLeft[0] + 120)
                .attr("height", bottomRight[1] - topLeft[1] + 120)
                .style("left", topLeft[0] - 50 + "px")
                .style("top", topLeft[1] - 50 + "px");

            linePath.attr("d", toLine)
            g.attr("transform", "translate(" + (-topLeft[0] + 50) + "," + (-topLeft[1] + 50) + ")");
        }

});

    </script>
</body>
</html>